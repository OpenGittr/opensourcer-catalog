services:
  taiga-db:
    image: postgres:12.3
    container_name: taiga-db
    environment:
      POSTGRES_DB: taiga
      POSTGRES_USER: taiga
      POSTGRES_PASSWORD: ${DB_PASSWORD:-taiga_password}
    volumes:
      - taiga-db:/var/lib/postgresql/data
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U taiga"]
      interval: 10s
      timeout: 5s
      retries: 5

  taiga-async-rabbitmq:
    image: rabbitmq:3.8-management-alpine
    container_name: taiga-async-rabbitmq
    environment:
      RABBITMQ_ERLANG_COOKIE: ${RABBITMQ_COOKIE:-secret-erlang-cookie}
      RABBITMQ_DEFAULT_USER: taiga
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-taiga}
      RABBITMQ_DEFAULT_VHOST: taiga
    volumes:
      - taiga-async-rabbitmq:/var/lib/rabbitmq
    restart: always

  taiga-events-rabbitmq:
    image: rabbitmq:3.8-management-alpine
    container_name: taiga-events-rabbitmq
    environment:
      RABBITMQ_ERLANG_COOKIE: ${RABBITMQ_COOKIE:-secret-erlang-cookie}
      RABBITMQ_DEFAULT_USER: taiga
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-taiga}
      RABBITMQ_DEFAULT_VHOST: taiga
    volumes:
      - taiga-events-rabbitmq:/var/lib/rabbitmq
    restart: always

  taiga-back:
    image: taigaio/taiga-back:latest
    container_name: taiga-back
    environment:
      POSTGRES_DB: taiga
      POSTGRES_USER: taiga
      POSTGRES_PASSWORD: ${DB_PASSWORD:-taiga_password}
      POSTGRES_HOST: taiga-db
      TAIGA_SECRET_KEY: ${SECRET_KEY:-taiga-back-secret-key}
      TAIGA_SITES_DOMAIN: ${TAIGA_DOMAIN:-localhost:9000}
      TAIGA_SITES_SCHEME: http
      TAIGA_SUBPATH: ""
      ENABLE_TELEMETRY: "False"
      RABBITMQ_USER: taiga
      RABBITMQ_PASS: ${RABBITMQ_PASSWORD:-taiga}
      EVENTS_PUSH_BACKEND_URL: amqp://taiga:${RABBITMQ_PASSWORD:-taiga}@taiga-events-rabbitmq:5672/taiga
      CELERY_BROKER_URL: amqp://taiga:${RABBITMQ_PASSWORD:-taiga}@taiga-async-rabbitmq:5672/taiga
    volumes:
      - taiga-static:/taiga-back/static
      - taiga-media:/taiga-back/media
    depends_on:
      taiga-db:
        condition: service_healthy
      taiga-async-rabbitmq:
        condition: service_started
      taiga-events-rabbitmq:
        condition: service_started
    restart: always

  taiga-async:
    image: taigaio/taiga-back:latest
    container_name: taiga-async
    entrypoint: ["/taiga-back/docker/async_entrypoint.sh"]
    environment:
      POSTGRES_DB: taiga
      POSTGRES_USER: taiga
      POSTGRES_PASSWORD: ${DB_PASSWORD:-taiga_password}
      POSTGRES_HOST: taiga-db
      TAIGA_SECRET_KEY: ${SECRET_KEY:-taiga-back-secret-key}
      TAIGA_SITES_DOMAIN: ${TAIGA_DOMAIN:-localhost:9000}
      TAIGA_SITES_SCHEME: http
      RABBITMQ_USER: taiga
      RABBITMQ_PASS: ${RABBITMQ_PASSWORD:-taiga}
      CELERY_BROKER_URL: amqp://taiga:${RABBITMQ_PASSWORD:-taiga}@taiga-async-rabbitmq:5672/taiga
    volumes:
      - taiga-static:/taiga-back/static
      - taiga-media:/taiga-back/media
    depends_on:
      - taiga-back
    restart: always

  taiga-events:
    image: taigaio/taiga-events:latest
    container_name: taiga-events
    environment:
      RABBITMQ_USER: taiga
      RABBITMQ_PASS: ${RABBITMQ_PASSWORD:-taiga}
      RABBITMQ_URL: amqp://taiga:${RABBITMQ_PASSWORD:-taiga}@taiga-events-rabbitmq:5672/taiga
      TAIGA_SECRET_KEY: ${SECRET_KEY:-taiga-back-secret-key}
    depends_on:
      - taiga-events-rabbitmq
    restart: always

  taiga-front:
    image: taigaio/taiga-front:latest
    container_name: taiga-front
    environment:
      TAIGA_URL: http://${TAIGA_DOMAIN:-localhost:9000}
      TAIGA_WEBSOCKETS_URL: ws://${TAIGA_DOMAIN:-localhost:9000}
      TAIGA_SUBPATH: ""
    restart: always

  taiga-gateway:
    image: nginx:1.19-alpine
    container_name: taiga-gateway
    ports:
      - "9000:80"
    volumes:
      - taiga-static:/taiga/static:ro
      - taiga-media:/taiga/media:ro
    configs:
      - source: taiga-nginx
        target: /etc/nginx/conf.d/default.conf
    depends_on:
      - taiga-front
      - taiga-back
      - taiga-events
    restart: always

configs:
  taiga-nginx:
    content: |
      server {
        listen 80;
        client_max_body_size 100M;
        charset utf-8;

        location / {
          proxy_pass http://taiga-front/;
          proxy_set_header Host $$host;
          proxy_set_header X-Real-IP $$remote_addr;
          proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $$scheme;
        }

        location /api/ {
          proxy_pass http://taiga-back:8000/api/;
          proxy_set_header Host $$host;
          proxy_set_header X-Real-IP $$remote_addr;
          proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $$scheme;
        }

        location /admin/ {
          proxy_pass http://taiga-back:8000/admin/;
          proxy_set_header Host $$host;
          proxy_set_header X-Real-IP $$remote_addr;
          proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $$scheme;
        }

        location /static/ {
          alias /taiga/static/;
        }

        location /media/ {
          alias /taiga/media/;
        }

        location /events {
          proxy_pass http://taiga-events:8888/events;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $$http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_connect_timeout 7d;
          proxy_send_timeout 7d;
          proxy_read_timeout 7d;
        }
      }

volumes:
  taiga-db:
  taiga-static:
  taiga-media:
  taiga-async-rabbitmq:
  taiga-events-rabbitmq:
